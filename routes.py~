
from flask import *
from searcher import *
import mysql.connector
from mysqlConnecter import *
import os
import pdf
from searcher import *


connectMysql = mysqlConnect()
lemon = Searcher()
app = Flask(__name__)

@app.route('/')
def home():
	        return render_template('index.html')

@app.route('/login', methods=['POST','GET'])
def login():
	if request.method == 'POST':
		
		u = request.form['email']
		p = request.form['password']
		row = connectMysql.getMysqlQuerry(u);
		dbuname = row[0];
		dbpass = row[1];
		if dbpass != p:
			return render_template('error.html')
		else:
			

			if u == "admin":
				return render_template('adminhome.html')
			else:
				return render_template('userhome.html')


@app.route('/query', methods=['GET', 'POST'])
def query():
    if request.method == 'POST':
        q = request.form['searchbar']
        result = lemon.query(q)
	return render_template('results.html', result=result)

@app.route('/admin/upload', methods=['GET', 'POST'])
def upload():
    if request.method == 'GET':
        pdf.convert_all("/home/biglibrary/bigLibraryFlask/pdfs/", "/home/biglibrary/bigLibraryFlask/files/")
        os.system("hdfs dfs -rm /user/biglibrary/files/*")
        os.system("hdfs dfs -copyFromLocal /home/biglibrary/bigLibraryFlask/files/* /user/biglibrary/files")

        return render_template("results.html")

@app.route('/admin/index', methods=['GET', 'POST'])
def index():
    if request.method == 'GET':
        os.system("hadoop jar /home/biglibrary/bigLibraryFlask/TextIndexer/target/textIndexer-1.0.jar /user/biglibrary/files")
        return render_template("results.html")

@app.route('/pdfs/<path:path>', methods=['GET', 'POST'])
def data(path):
    if request.method == 'GET':
        return send_from_directory('data', path)

if __name__ == '__main__':
    app.debug = True
    app.run()
